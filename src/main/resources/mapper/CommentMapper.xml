<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gyj.gx.dao.CommentMapper">
    <resultMap id="nameMap" type="com.gyj.gx.domain.response.CommentDTO">
        <id column="id" property="id"/>
        <result column="from_uid" property="fromUid"/>
        <result column="comment_time" property="commentTime"/>
        <result column="content" property="content"/>
        <result column="replyToUid" property="reply_to_uid"/>
        <result column="reply_to_cid" property="replyToCid"/>
        <result column="pid" property="pid"/>
        <result column="likes_count" property="likesCount"/>
        <result column="nickname" property="nickname"/>
        <result column="avatar" property="avatar"/>
        <result column="to_nickname" property="toNickname"/>
        <result column="to_avatar" property="toAvatar"/>
    </resultMap>

    <resultMap id="hotCommentMap" type="com.gyj.gx.domain.response.HotCommentDTO">
        <id column="id" property="id"/>
        <result column="likes_count" property="likesCount"/>
        <result column="content" property="content"/>
        <result column="pid" property="pid"/>
        <result column="description" property="description"/>
    </resultMap>

    <select id="getCommentRelatedToProblem" resultMap="nameMap">
        SELECT c.id,c.from_uid,c.comment_time,c.content,c.reply_to_cid,c.reply_to_uid,c.pid,c.likes_count,u.nickname,u.avatar,
               tu.nickname AS to_nickname,tu.avatar AS to_avatar
        FROM t_comment c
                 LEFT JOIN (SELECT id,nickname,avatar
                            FROM t_user
                            WHERE deleted=0) u ON u.id=c.from_uid
                 LEFT JOIN (SELECT id,nickname,avatar
                            FROM t_user
                            WHERE deleted=0) tu ON tu.id = c.reply_to_uid
        WHERE c.deleted=0
          AND c.pid=#{map.pid}
        ORDER BY c.id DESC
    </select>

    <select id="likeComment" resultType="Integer">
        UPDATE t_comment
        SET likes_count=likes_count+1
        WHERE  id=#{map.id};
        SELECT c.likes_count
        FROM t_comment c
        WHERE  id=#{map.id}
    </select>

    <select id="unlikeComment" resultType="Integer">
        UPDATE t_comment
        SET likes_count=likes_count-1
        WHERE  id=#{map.id};
        SELECT c.likes_count
        FROM t_comment c
        WHERE  id=#{map.id}
    </select>

    <select id="hotComment" resultMap="hotCommentMap">
        SELECT c.id,
               c.likes_count,
               c.content,
               c.pid,
               p.description
        FROM t_comment c
                 LEFT JOIN t_problem p ON p.id =c.pid AND p.deleted = 0
        WHERE c.deleted = 0
        ORDER BY c.likes_count DESC
        LIMIT 10
    </select>
</mapper>